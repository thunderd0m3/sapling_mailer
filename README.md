# sapling_mailer

An application which accepts email attributes and delivers them via third party mailer APIs

# How it works
1. Accepts POST requests on /email with required email attributes
2. Saves valid email requests in postgres
3. Attempts to deliver the request contents in an email via Sendgrid API
4. If Sendgrid's response is unsuccessful, it attempts to send the email via Postmark API
---
# Project Notes
## What framework was chosen
* I used ruby/rails as it's my favorite to code in, and it fits the problem well
## If I had more time, what would I change
* I would call RedundantMailer asynchronously, possibly using Sidekiq. 
* Make the dynamic provider switching more robust. Check specific error statuses and add retries before falling back to the secondary provider
* Clean out unnecessary files generated by rails scaffolding
## Testing
* All classes have thorough specs
* I chose a request spec over a controller spec. Request specs are less brittle and encourage lean controllers
## Design
* RedundantMailer is built to easily handle a change in strategy for api fallback
* EmailSender is abstracted to that we can easily add more third party mailers
## Where should the reviewer start?
* controllers/email_controller, tests: (spec/requests)
* models/email_request, tests: (spec/models/email_request)
* lib/, tests: (spec/lib)


---
# Ruby Version
2.6.3
---
# Setup
Inside project directory:
```
bundle install
bin/rails db:prepare
bin/rails db:migrate
```
* Insert your Sendgrid and Postmark api keys into config/application.rb under these environment variables:
ENV["SENDGRID_API_KEY"]
ENV["POSTMARK_API_KEY"]
---
# How to run the test suite
Inside project directory:
```
bundle exec rspec
```
---
# Using the application
From command line in project directory:
```
bin/rails s
```
Assuming you're running on localhost:3000, here is an example POST request:
```
curl -X POST \
  http://localhost:3000/email \
  -H 'Accept: */*' \
  -H 'Content-Type: application/json' \
  -H 'Host: localhost:3000' \
  -d '{
	"to": "youremail@example.com",
	"to_name": "Jon Doe",
	"from": "anotheremail@example.com",
	"from_name": "Jane Doe",
	"subject": "A Message from Uber",
	"body": "<h1>Your Bill</h1><p>$10</p>"
}'
```
## To trigger a failure on SendGrid and have the app send via Postmark
Edit ENV["SENDGRID_API_KEY"] to be invalid.
Restart rails server.
### Note
Postmark requires the account have the "from" address setup and verified as a sender on your account

---
# Controllers

## EmailController
### Methods
#### create
* Attempts to create EmailRequest object from request params, and save to postgres
* If save was successful, it utilizes RedundantMailer to deliver the EmailRequest
* If save was not successful, it responds with 422

---
# Classes

## EmailRequest
### Constructor
* Initialize with required email attributes (all Strings):
```
:to, :to_name, :from, :from_name, :subject, :body
```

### Public Methods
#### plain_text_body
* returns body string with html tags stripped

## RedundantMailer
### Constructor
Initialize with EmailRequest object

### Public Methods
#### ensure_delivery(email_request)
* First, utilizes SendgridEmailSender to deliver email
* If response was unsuccessful, it utilizes PostmarkEmailSender to deliver email

## EmailSender
* Abstract class which utilizes Faraday to send post request on a connection

## SendgridEmailSender
### Constructor
Initialize with EmailRequest object

### Public Methods
#### deliver(email_request)
* Sends a POST request to Sendgrid API with email attributes

## PostmarkEmailSender
### Constructor
Initialize with EmailRequest object

### Public Methods
#### deliver(email_request)
* Sends a POST request to Postmark API with email attributes
